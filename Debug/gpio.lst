Zilog eZ80 Macro Assembler Version 4.3 (19073001)24-Jun-23     07:37:07     page:   1


PC     Object              I  Line    Source 
                           A     1    ;
                           A     2    ; Title:	AGON MOS - gpio code
                           A     3    ; Author:	Dean Belfield
                           A     4    ; Created:	15/07/2022
                           A     5    ; Last Updated:	24/07/2022
                           A     6    ;
                           A     7    ; Modinfo:
                           A     8    ; 24/07/2022:	Moved SWITCH_A to misc.asm
                           A     9    
                           B     0    			INCLUDE	"macros.inc"
                           B     1    ;
                           B     2    ; Title:	AGON MOS - Useful Macros
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	15/07/2022
                           B     5    ; Last Updated:	19/09/2022
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    ; 08/08/2022:	Added GET_GPIO
                           B     9    ; 09/09/2022:	Commented
                           B    10    
                           B    11    ; Add A to HL (unsigned)
                           B    12    ;
                           B    13    ADD8U_HL:		MACRO 
                           B    14    			ADD	A, L 
                           B    15    			LD	L, A 
                           B    16    			ADC	A, H
                           B    17    			SUB	L
                           B    18    			LD	H, A 
                           B    19    			ENDMACRO 
                           B    20    
                           B    21    ; Set a GPIO register
                           B    22    ; Parameters:
                           B    23    ; - REG: Register to set
                           B    24    ; - VAL: Bit(s) to set (1: set, 0: ignore)
                           B    25    ;
                           B    26    SET_GPIO:		MACRO	REG, VAL
                           B    27    			IN0	A,(REG)
                           B    28    			OR	VAL
                           B    29    			OUT0	(REG),A
                           B    30    			ENDMACRO
                           B    31    
                           B    32    ; Reset a GPIO register
                           B    33    ; Parameters:
                           B    34    ; - REG: Register to set
                           B    35    ; - VAL: Bit(s) to reset (1: reset, 0: ignore)
                           B    36    ;	
                           B    37    RES_GPIO:		MACRO	REG, VAL
                           B    38    			PUSH	BC
                           B    39    			LD	A, VAL
                           B    40    			CPL
                           B    41    			LD	C, A
                           B    42    			IN0	A,(REG)
                           B    43    			AND	C
                           B    44    			OUT0	(REG),A
                           B    45    			POP	BC
                           B    46    			ENDMACRO
                           B    47    
                           B    48    ; Get a GPIO register
                           B    49    ; Parameters:
                           B    50    ; - REG: Register to test
                           B    51    ; - VAL: Bit(s) to test
                           B    52    ;	
                           B    53    GET_GPIO:		MACRO	REG, VAL
                           B    54    			IN0	A,(REG)
                           B    55    			TST	A, VAL
                           B    56    			ENDMACRO
                           B    57    				
                           B     0    			INCLUDE	"equs.inc"
                           B     1    ;
                           B     2    ; Title:	AGON MOS - Equs
                           B     3    ; Author:	Dean Belfield
                           B     4    ; Created:	15/07/2022
                           B     5    ; Last Updated:	19/03/2023
                           B     6    ;
                           B     7    ; Modinfo:
                           B     8    ; 24/07/2022:	Added TMR2_CTL
                           B     9    ; 03/08/2022:	Added UART0_BUFFERLEN
                           B    10    ; 20/08/2022:	Added some VDP protocol flags
                           B    11    ; 18/09/2022:	Added VDPP_FLAG_MODE
                           B    12    ; 09/03/2023:	Renamed TMR2_CTL to TMR0_CTL
                           B    13    ; 15/03/2023:	Added VDPP_FLAG_RTC
                           B    14    ; 19/03/2023:	Fixed TMR0_RR_H to point to cor
                           B    15    
                           B    16    ; MOS specific
                           B    17    ;
       00000010            B    18    VDPP_BUFFERLEN:		EQU		16	; VDP Protocol 
                           B    19    	
       00000001            B    20    VDPP_FLAG_CURSOR:	EQU		00000001b
       00000002            B    21    VDPP_FLAG_SCRCHAR:	EQU		00000010b
       00000004            B    22    VDPP_FLAG_POINT:	EQU		00000100b
       00000008            B    23    VDPP_FLAG_AUDIO:	EQU		00001000b	
       00000010            B    24    VDPP_FLAG_MODE:		EQU		00010000b
       00000020            B    25    VDPP_FLAG_RTC:		EQU		00100000b
                           B    26    
                           B    27    ; For GPIO
                           B    28    ; PA not available on eZ80F92
                           B    29    ;
       00000096            B    30    PA_DR:			EQU		96h
       00000097            B    31    PA_DDR:			EQU		97h
       00000098            B    32    PA_ALT1:		EQU		98h
       00000099            B    33    PA_ALT2:		EQU		99h
       0000009A            B    34    PB_DR:          	EQU		9Ah
       0000009B            B    35    PB_DDR:        	 	EQU		9Bh
       0000009C            B    36    PB_ALT1:        	EQU		9Ch
       0000009D            B    37    PB_ALT2:        	EQU		9Dh
       0000009E            B    38    PC_DR:          	EQU		9Eh
       0000009F            B    39    PC_DDR:         	EQU		9Fh
       000000A0            B    40    PC_ALT1:        	EQU		A0h
       000000A1            B    41    PC_ALT2:        	EQU		A1h
       000000A2            B    42    PD_DR:          	EQU		A2h
       000000A3            B    43    PD_DDR:			EQU		A3h
       000000A4            B    44    PD_ALT1:		EQU		A4h
       000000A5            B    45    PD_ALT2:		EQU		A5h
                           B    46    	
       00000000            B    47    GPIOMODE_OUT:		EQU		0	; Output
       00000001            B    48    GPIOMODE_IN:		EQU		1	; Input
       00000002            B    49    GPIOMODE_DIO:		EQU		2	; Open Drain IO
       00000003            B    50    GPIOMODE_SIO:		EQU		3	; Open Source I
       00000004            B    51    GPIOMODE_INTD:		EQU		4	; Interrupt, Du
       00000005            B    52    GPIOMODE_ALTF:		EQU		5;	; Alt Function
       00000006            B    53    GPIOMODE_INTAL:		EQU		6	; Interrupt, Ac
       00000007            B    54    GPIOMODE_INTAH:		EQU		7	; Interrupt, Ac
       00000008            B    55    GPIOMODE_INTFE:		EQU		8	; Interrupt, Fa
       00000009            B    56    GPIOMODE_INTRE:		EQU		9	; Interrupt, Ri
                           B    57    	
                           B    58    ; For interrupts.asm
                           B    59    ;
                           B    60    
                           B    61    ;UARTs
                           B    62    ;
       00000018            B    63    UART0_IVECT		EQU	18h
       0000001A            B    64    UART1_IVECT		EQU	1Ah
                           B    65    
                           B    66    ;Ports
                           B    67    ;
       00000030            B    68    PB0_IVECT   		EQU   	30h	; AGON ITRP Int
       00000032            B    69    PB1_IVECT  	  	EQU  	32h	; AGON VBLANK Inter
       00000034            B    70    PB2_IVECT  	  	EQU   	34h
       00000036            B    71    PB3_IVECT  	  	EQU   	36h
       00000038            B    72    PB4_IVECT    		EQU   	38h
       0000003A            B    73    PB5_IVECT    		EQU   	3Ah
       0000003C            B    74    PB6_IVECT    		EQU   	3Ch
       0000003E            B    75    PB7_IVECT    		EQU   	3Eh
                           B    76                           
       00000040            B    77    PC0_IVECT    		EQU   	40h
       00000042            B    78    PC1_IVECT    		EQU   	42h
       00000044            B    79    PC2_IVECT    		EQU   	44h
       00000046            B    80    PC3_IVECT    		EQU   	46h
       00000048            B    81    PC4_IVECT    		EQU   	48h
       0000004A            B    82    PC5_IVECT    		EQU   	4Ah
       0000004C            B    83    PC6_IVECT    		EQU   	4Ch
       0000004E            B    84    PC7_IVECT    		EQU   	4Eh
                           B    85                           
       00000050            B    86    PD0_IVECT    		EQU   	50h
       00000052            B    87    PD1_IVECT    		EQU   	52h
       00000054            B    88    PD2_IVECT    		EQU   	54h
       00000056            B    89    PD3_IVECT    		EQU   	56h
       00000058            B    90    PD4_IVECT    		EQU   	58h
       0000005A            B    91    PD5_IVECT    		EQU   	5Ah
       0000005C            B    92    PD6_IVECT    		EQU   	5Ch
       0000005E            B    93    PD7_IVECT    		EQU   	5Eh
                           B    94    
                           B    95    ; For vectors16.asm
                           B    96    ;
       00000080            B    97    TMR0_CTL		EQU	80h
       00000081            B    98    TMR0_DR_L               EQU     81h
       00000081            B    99    TMR0_RR_L               EQU     81h
       00000082            B   100    TMR0_DR_H               EQU     82h
       00000082            B   101    TMR0_RR_H               EQU     82h
                           B   102    
       00000083            B   103    TMR1_CTL		EQU	83h
       00000084            B   104    TMR1_DR_L               EQU     84h
       00000084            B   105    TMR1_RR_L               EQU     84h
       00000085            B   106    TMR1_DR_H               EQU     85h
       00000085            B   107    TMR1_RR_H               EQU     85h
                           B   108    
                           B   109    ; UART constants
       00000050            B   110    UART0_SEND_BUFFER_SIZE  EQU     80
       00000050            B   111    UART0_RECV_BUFFER_SIZE  EQU     80
       00000002            B   112    UART_IER_TRANSMITINT    EQU     00000010b
                           A    12    
                           A    13    			.ASSUME	ADL = 1
                           A    14    
                           A    15    			DEFINE .STARTUP, SPACE = ROM
                           A    16    			SEGMENT .STARTUP
                           A    17    				
                           A    18    			XDEF	GPIOB_SETMODE				
                           A    19    			XREF	SWITCH_A
                           A    20    			
                           A    21    ;  A: Mode
                           A    22    ;  B: Pins
                           A    23    ;  				
000000 CD 00 00 00         A    24    GPIOB_SETMODE:		CALL	SWITCH_A
000004 1800                A    25    			DW	GPIOB_M0	; Output
000006 3D00                A    26    			DW	GPIOB_M1	; Input
000008 5D00                A    27    			DW	GPIOB_M2	; Open Drain IO
00000A 7D00                A    28    			DW	GPIOB_M3	; Open Source IO
00000C 9800                A    29    			DW	GPIOB_M4	; Interrupt, Dual E
00000E C400                A    30    			DW	GPIOB_M5	; Alt Function
000010 DF00                A    31    			DW	GPIOB_M6	; Interrupt, Active
000012 0601                A    32    			DW	GPIOB_M7	; Interrupt, Active
000014 2801                A    33    			DW	GPIOB_M8	; Interrupt, Fallin
000016 4A01                A    34    			DW	GPIOB_M9	; Interrupt, Rising
                           A    35    
                           A    36    ; Output
                           A    37    ;
000018                     A    38    GPIOB_M0:		RES_GPIO PB_DDR,  B
                           A    39    			RES_GPIO PB_ALT1, B
                           A    40    			RES_GPIO PB_ALT2, B
00003C C9                  A    41    			RET
                           A    42    
                           A    43    ; Input
                           A    44    ;
00003D                     A    45    GPIOB_M1:		SET_GPIO PB_DDR,  B
                           A    46    			RES_GPIO PB_ALT1, B
                           A    47    			RES_GPIO PB_ALT2, B
00005C C9                  A    48    			RET
                           A    49    
                           A    50    ; Open Drain IO
                           A    51    ;
00005D                     A    52    GPIOB_M2:		RES_GPIO PB_DDR,  B
                           A    53    			SET_GPIO PB_ALT1, B
                           A    54    			RES_GPIO PB_ALT2, B
00007C C9                  A    55    			RET
                           A    56    
                           A    57    ; Open Source IO
                           A    58    ;
00007D                     A    59    GPIOB_M3:		SET_GPIO PB_DDR,  B
                           A    60    			SET_GPIO PB_ALT1, B
                           A    61    			RES_GPIO PB_ALT2, B
000097 C9                  A    62    			RET
                           A    63    
                           A    64    ; Interrupt, Dual Edge
                           A    65    ;
000098                     A    66    GPIOB_M4:		SET_GPIO PB_DR,   B
                           A    67    			RES_GPIO PB_DDR,  B
                           A    68    			RES_GPIO PB_ALT1, B
                           A    69    			RES_GPIO PB_ALT2, B
0000C3 C9                  A    70    			RET
                           A    71    
                           A    72    ; Alt Function
                           A    73    ;
0000C4                     A    74    GPIOB_M5:		SET_GPIO PB_DDR,  B
                           A    75    			RES_GPIO PB_ALT1, B
                           A    76    			SET_GPIO PB_ALT2, B
0000DE C9                  A    77    			RET
                           A    78    
                           A    79    ; Interrupt, Active Low
                           A    80    ;
0000DF                     A    81    GPIOB_M6:		RES_GPIO PB_DR,   B
                           A    82    			RES_GPIO PB_DDR,  B
                           A    83    			SET_GPIO PB_ALT1, B
                           A    84    			SET_GPIO PB_ALT2, B
000105 C9                  A    85    			RET
                           A    86    
                           A    87    
                           A    88    ; Interrupt, Active High
                           A    89    ;
000106                     A    90    GPIOB_M7:		SET_GPIO PB_DR,   B
                           A    91    			RES_GPIO PB_DDR,  B
                           A    92    			SET_GPIO PB_ALT1, B
                           A    93    			SET_GPIO PB_ALT2, B
000127 C9                  A    94    			RET
                           A    95    
                           A    96    
                           A    97    ; Interrupt, Falling Edge
                           A    98    ;
000128                     A    99    GPIOB_M8:		RES_GPIO PB_DR,   B
                           A   100    			SET_GPIO PB_DDR,  B
                           A   101    			SET_GPIO PB_ALT1, B
                           A   102    			SET_GPIO PB_ALT2, B
000149 C9                  A   103    			RET
                           A   104    	
                           A   105    ; Interrupt, Rising Edge
                           A   106    ;
00014A                     A   107    GPIOB_M9:		SET_GPIO PB_DR,   B
                           A   108    			SET_GPIO PB_DDR,  B
                           A   109    			SET_GPIO PB_ALT1, B
                           A   110    			SET_GPIO PB_ALT2, B
000166 C9                  A   111    			RET	


Errors: 0
Warnings: 0
Lines Assembled: 501
